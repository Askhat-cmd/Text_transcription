# Knowledge Graph

## Навигация

- [Назад к README](../README.md)
- [Обзор проекта](./overview.md)
- [Архитектура](./architecture.md)
- [SAG v2.0](./sag_v2.md)

---

## Описание и назначение

**Назначение документа**: Описать Knowledge Graph в Bot Psychologist, его структуру, использование и интеграцию с Phase 3.

**Для кого**: Разработчики, работающие с Knowledge Graph и Phase 3.

**Что содержит**:
- Структура Knowledge Graph
- Типы узлов и связей
- Методы поиска в графе
- Рекомендация практик
- Интеграция с Phase 3

---

## Что такое Knowledge Graph

**Knowledge Graph** — граф знаний, построенный из SAG v2.0 данных, содержащий:

- **Узлы**: концепты, практики, техники, упражнения, паттерны, этапы процессов
- **Связи**: отношения между узлами (IS_PRACTICE_FOR, REQUIRES, ENABLES, etc.)

### Статистика графа

После загрузки всех данных граф содержит:
- **95 узлов** различных типов
- **2182 связи** между узлами
- **6 типов узлов**
- **8+ типов связей**

---

## Структура графа

### GraphNode

```python
class GraphNode:
    node_id: str           # Уникальный ID узла
    name: str              # Человекочитаемое имя
    node_type: str         # Тип узла (CONCEPT, PRACTICE, etc.)
    metadata: Dict          # Дополнительные метаданные
```

### GraphEdge

```python
class GraphEdge:
    from_id: str           # ID исходного узла
    to_id: str             # ID целевого узла
    from_name: str         # Имя исходного узла
    to_name: str           # Имя целевого узла
    edge_type: str         # Тип связи
    explanation: str       # Пояснение связи
    confidence: float      # Уверенность (0.0-1.0)
    metadata: Dict         # Дополнительные метаданные
```

---

## Типы узлов

### CONCEPT
Абстрактный концепт или идея.

**Примеры**: осознавание, трансформация, нейросталкинг, неосталкинг

**Использование**: Основные концепты, которые объясняются в лекциях.

### PRACTICE
Практика или метод работы с концептом.

**Примеры**: медитация, дыхательные практики, работа с вниманием

**Использование**: Рекомендация практик для концептов через связи IS_PRACTICE_FOR.

### TECHNIQUE
Конкретная техника выполнения практики.

**Примеры**: техника осознанного дыхания, техника сканирования тела

**Использование**: Детальные инструкции по выполнению практик.

### EXERCISE
Конкретное упражнение.

**Примеры**: упражнение на осознавание дыхания, упражнение на внимание

**Использование**: Практические упражнения для развития навыков.

### PATTERN
Паттерн поведения или мышления.

**Примеры**: паттерн избегания, паттерн сопротивления

**Использование**: Распознавание и работа с паттернами.

### PROCESS_STAGE
Этап процесса трансформации.

**Примеры**: этап осознавания, этап принятия, этап интеграции

**Использование**: Построение путей трансформации.

---

## Типы связей

### IS_PRACTICE_FOR
Практика для концепта.

**Пример**: медитация IS_PRACTICE_FOR осознавание

**Использование**: Поиск практик для концептов.

### IS_TECHNIQUE_FOR
Техника для практики или концепта.

**Пример**: техника дыхания IS_TECHNIQUE_FOR медитация

**Использование**: Поиск техник для практик.

### REQUIRES
Требует наличия другого узла.

**Пример**: практика медитации REQUIRES базовое понимание осознавания

**Использование**: Определение предпосылок для практик.

### ENABLES
Делает возможным другой узел.

**Пример**: развитие осознавания ENABLES трансформацию

**Использование**: Построение цепочек развития.

### IS_PART_OF
Является частью другого узла.

**Пример**: техника дыхания IS_PART_OF медитация

**Использование**: Построение иерархий.

### HAS_PART
Содержит часть (обратная связь IS_PART_OF).

**Пример**: медитация HAS_PART техника дыхания

**Использование**: Построение иерархий.

### RELATED_TO
Связан с другим узлом.

**Пример**: осознавание RELATED_TO внимание

**Использование**: Поиск связанных концептов.

### PREREQUISITE
Предпосылка для другого узла.

**Пример**: базовое понимание осознавания PREREQUISITE практика медитации

**Использование**: Определение последовательности обучения.

---

## GraphClient (`bot_agent/graph_client.py`)

### Загрузка графа

```python
# Загрузка графа из всех документов
graph_client.load_graphs_from_all_documents()

# Процесс:
# 1. Проход по всем блокам из DataLoader
# 2. Извлечение graph_entities → узлы графа
# 3. Извлечение graph_relations → связи графа
# 4. Построение adjacency списка для быстрого поиска
```

### Методы поиска

#### find_nodes_by_name
Поиск узлов по имени (точное совпадение или частичное).

```python
nodes = graph_client.find_nodes_by_name("осознавание")
# [GraphNode(id="concept_001", name="осознавание", type="CONCEPT")]
```

#### find_related_nodes
Поиск связанных узлов через связи.

```python
related = graph_client.find_related_nodes("concept_001", relation_type="IS_PRACTICE_FOR")
# [GraphNode(id="practice_001", name="медитация", type="PRACTICE")]
```

#### find_practices_for_concept
Поиск практик для концепта.

```python
practices = graph_client.find_practices_for_concept("осознавание")
# [GraphNode(name="медитация"), GraphNode(name="дыхательные практики")]
```

#### find_path
Поиск пути между двумя узлами (BFS).

```python
path = graph_client.find_path("concept_001", "concept_002", max_depth=3)
# [GraphNode(...), GraphNode(...), GraphNode(...)]
```

#### get_node_connections
Получить все связи узла.

```python
connections = graph_client.get_node_connections("concept_001")
# [GraphEdge(...), GraphEdge(...)]
```

---

## PracticesRecommender (`bot_agent/practices_recommender.py`)

### Рекомендация практик

**Назначение**: Рекомендация практик на основе концептов из запроса пользователя.

**Процесс**:

1. **Извлечение концептов** из запроса
2. **Поиск практик** через граф (IS_PRACTICE_FOR)
3. **Фильтрация** по релевантности
4. **Ранжирование** по количеству связей

```python
# Рекомендация практик
practices = practices_recommender.recommend_practices(
    concepts=["осознавание", "трансформация"],
    user_level=UserLevel.BEGINNER,
    max_results=5
)
```

### Фильтрация по уровню

- **BEGINNER**: простые практики с базовыми техниками
- **INTERMEDIATE**: практики среднего уровня
- **ADVANCED**: продвинутые практики

---

## Интеграция с Phase 3

### Graph-powered QA

**Процесс**:

```
Пользовательский запрос
    ↓
[SemanticAnalyzer] → Извлечение концептов
    ↓
[GraphClient] → Поиск узлов в графе
    ↓
[GraphClient] → Поиск практик через IS_PRACTICE_FOR
    ↓
[PracticesRecommender] → Рекомендация практик
    ↓
[Retriever] → Поиск блоков с практиками
    ↓
[LLMAnswerer] → Ответ с практиками из графа
```

### Пример ответа

```
Вопрос: "Как развить осознавание?"

Ответ:
"Для развития осознавания рекомендую следующие практики:

1. Медитация осознавания
   - Техника: фокус на дыхании
   - Частота: ежедневно по 10-15 минут
   - Связь: медитация IS_PRACTICE_FOR осознавание

2. Дыхательные практики
   - Техника: осознанное дыхание
   - Частота: несколько раз в день
   - Связь: дыхание ENABLES развитие осознавания

Источники:
- Лекция "Основы осознавания" [00:15:30 - 00:20:45]
- Лекция "Практики медитации" [00:30:10 - 00:35:20]
"
```

---

## Построение путей трансформации (Phase 4)

### PathBuilder (`bot_agent/path_builder.py`)

**Назначение**: Построение персональных путей трансформации на основе Knowledge Graph.

**Процесс**:

1. **Определение текущего состояния** пользователя
2. **Определение целевого состояния** (обычно INTEGRATED)
3. **Поиск пути** через граф от текущего к целевому
4. **Рекомендация практик** для каждого шага пути

```python
# Построение пути
path = path_builder.build_path(
    user_id="user_123",
    state_analysis=state_analysis,
    user_level=UserLevel.BEGINNER,
    memory=conversation_memory,
    target_state=UserState.INTEGRATED
)
```

### Структура пути

```python
PersonalTransformationPath(
    current_state=UserState.CURIOUS,
    target_state=UserState.INTEGRATED,
    path_steps=[
        TransformationPathStep(
            step_number=1,
            title="Развитие базового осознавания",
            duration_weeks=2,
            practices=["медитация", "дыхательные практики"],
            key_concepts=["осознавание", "внимание"]
        ),
        # ...
    ],
    total_duration_weeks=8
)
```

---

## Примеры использования

### Пример 1: Поиск практик для концепта

```python
# Концепт из запроса
concept = "осознавание"

# Поиск практик через граф
practices = graph_client.find_practices_for_concept(concept)
# [GraphNode(name="медитация"), GraphNode(name="дыхательные практики")]

# Рекомендация
recommendation = practices_recommender.recommend(
    practices,
    user_level=UserLevel.BEGINNER
)
```

### Пример 2: Поиск пути между концептами

```python
# Поиск пути от концепта A к концепту B
path = graph_client.find_path(
    "concept_001",  # осознавание
    "concept_002",  # трансформация
    max_depth=5
)

# Путь через граф
# осознавание → практика медитации → развитие внимания → трансформация
```

### Пример 3: Построение иерархии

```python
# Получить все части концепта
parts = graph_client.get_node_connections(
    "concept_001",
    relation_type="HAS_PART"
)

# Иерархия:
# осознавание
#   ├─ практика медитации
#   │   ├─ техника дыхания
#   │   └─ техника сканирования тела
#   └─ практика внимания
```

---

## Оптимизации

### Кэширование

- **В памяти**: весь граф загружается один раз при старте
- **Индексы**: быстрый поиск по имени узла, по типу связи

### Поиск

- **BFS**: для поиска путей между узлами
- **DFS**: для глубокого поиска связей
- **Adjacency список**: для быстрого доступа к связям узла

---

## Навигация

- [Обзор проекта](./overview.md)
- [Архитектура](./architecture.md)
- [SAG v2.0](./sag_v2.md)
- [Bot Agent](./bot_agent.md)
